* GENERATED BY CHARMM-GUI (http://www.charmm-gui.org) v2.0 on Nov, 01. 2019. JOBID=157262154737
* GENERATES WATER BOX TO SOLVATE THE PROTEIN/MEMBRANE COMPLEX
*

DIMENS CHSIZE 3000000 MAXRES 3000000

! Read topology and parameter files
stream toppar.str

! read system file to make water box to be added
stream step3_size.str

calc Xinit = @A
calc Yinit = @B
calc Zinit = @watboxZ

set BOX = @BoxType

IF BOX .eq. RECT THEN
   calc BoxSizeX = @Xinit !from user input
   calc BoxSizeY = @Yinit !from user input
   calc BoxSizeZ = @Zinit !from user input

   set XTLtype = ORTHorhombic
   if BoxSizeX .eq. @BoxSizeY if BoxSizeX .ne. @BoxSizeZ set XTLtype = TETRagonal
   if BoxSizeX .eq. @BoxSizeY if BoxSizeX .eq. @BoxSizeZ set XTLtype = CUBIc
   set A = @BoxSizeX
   set B = @BoxSizeY
   set C = @BoxSizeZ
   set Alpha = 90.0
   set Beta  = 90.0
   set Gamma = 90.0
ENDIF

IF BOX .eq. HEXA THEN
   set XTLtype  = HEXAgonal
   set A = @Xinit !from user input
   set B = @A
   set C = @Zinit !from user input
   set Alpha =  90.0
   set Beta  =  90.0
   set Gamma = 120.0

   calc BoxSizeX = @A / cos ( 30.0 * ?pi / 180.0 )
   calc BoxSizeY = @A / cos ( 30.0 * ?pi / 180.0 )
   calc BoxSizeZ = @C
ENDIF

IF BOX .eq. OCTA THEN
   set XTLtype  = OCTAhedral
   set A = @Xinit
   set B = @A
   set C = @A
   set Alpha = 109.4712206344907
   set Beta  = 109.4712206344907
   set Gamma = 109.4712206344907

   calc BoxSizeX = @A * 1.1
   calc BoxSizeY = @A * 1.1
   calc BoxSizeZ = @A * 1.1
ENDIF

! a pre-equilibrated water cubic box with L=18.8560
set L 18.8560

! number of boxes along XYZ-directions
calc Xnum = int(@BoxSizeX/@L) + 1
calc Ynum = int(@BoxSizeY/@L) + 1
calc Znum = int(@BoxSizeZ/@L) + 1

read sequence TIP3 216
generate W000 setup noangle nodihedral

open read unit 10 card name toppar/tip216.crd
read coor unit 10 card
close unit 10

coor stat sele type OH2 end
calc Lhalf = @L / 2.0
coor trans xdir 1.0 dist @Lhalf
coor trans ydir 1.0 dist @Lhalf
coor trans zdir 1.0 dist @Lhalf
coor stat sele type OH2 end

bomlev -5

! planar water box unit
set J2  1
label DO_2
    set J1  1
    label DO_1

    read sequence TIP3 216

    generate @{J1}W@{J2} setup noangle nodihedral

    coor duplicate select segid W000 end select segid @{J1}W@{J2} end

    calc X = @L * ( @J1 - 1 )  ! mult X by @J1
    calc Y = @L * ( @J2 - 1 )  ! mult Y by @J2

    coor trans xdir @X ydir @Y select segid @{J1}W@{J2} end


    incr J1 by 1
    if J1 le @Xnum goto DO_1
incr J2 by 1
if J2 le @Ynum goto DO_2

delete atom sele .byres. ( ( type OH2 ) .and. -
                           ( prop X .gt. @BoxSizeX .or. -
                             prop Y .gt. @BoxSizeY ) ) end

delete atom sele segid W000 end

open write unit 10 card name water_tmp.crd
write coor unit 10 card

delete atom sele all end

! generate water box by stacking planar water boxes
set J3  1
label DO_3

    open read card unit 10 name water_tmp.crd
    read sequence coor card unit 10
    generate W@J3 setup warn noangle nodihedral

    open read unit 10 card name water_tmp.crd
    read coor unit 10 card append

    calc Z = @L * ( @J3 - 1 )  ! mult Y by @J3
    coor trans zdir @Z select segid W@J3 end

incr J3 by 1
if J3 le @Znum goto DO_3

delete atom sele .byres. ( ( type OH2 ) .and. -
                           ( prop Z .gt. @BoxSizeZ ) ) end
coor stat sele type OH2 end
coor orient norotation
coor stat sele type OH2 end

!
!Shaping the box
!
IF BOX .ne. RECT THEN
   COOR CONVERT ALIGNED SYMMETRIC @A @B @C @alpha @beta @gamma

   coor copy comp
   CRYSTAL DEFINE @XTLtype @A @B @C @alpha @beta @gamma
   CRYSTAL BUILD NOPER 0 CUTOFF 2.0
   IMAGE BYRESID XCEN 0.0 YCEN 0.0 ZCEN 0.0

      nbonds ctonnb 2.0 ctofnb 3.0 cutnb 3.0 cutim 3.0 wmin 0.1
      crystal free

   coor diff comp
   delete atom sele .byres. ( ( prop Xcomp .ne. 0 ) .or. -
                              ( prop Ycomp .ne. 0 ) .or. -
                              ( prop Zcomp .ne. 0 ) ) end
ENDIF

set crdfile = step4.2_waterbox.crd

open write unit 10 card name @crdfile
write coor unit 10 card
* Equilibrated water
*

stop
